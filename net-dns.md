## Поиск доменных имен и поддоменов
### Методы активного поиска доменных имен и поддоменов

1. Опрашивание DNS сервиса на известные ему записи раскрывающие доменные имена, связанные с доменом 2-го уровня. Т.е. выполнение запросов к таким DNS записям, как: CNAME, MX, NS, SRV и т.д. [Подробнее](https://ru.wikipedia.org/wiki/Типы_ресурсных_записей_DNS)  

`A` – используется для указания доменного имени, например, testdomain.com, на IP-адрес его хост-сервера;  
`MX` – записи, отвечающие за обмен электронной почтой;  
`NS` – предназначены для идентификации DNS-серверов, ответственных за домен;  
`SRV` – записи для выделения службы, размещенной на определенных серверах;  
`PTR` – обратный поиск DNS: с помощью IP вы можете получить связанный с ним домен;  
`SOA` – начало записи: это информация о зоне DNS и других записях DNS;  
`CNAME` – сопоставляет целевое доменное имя с другим доменным именем.  

Чтобы получить записи всех типов можно использовать тип запроса `ANY`.

Пример выполнения запроса:  
```
nslookup -q=ANY example.com ns.example.com
```

2. Перебор доменных имен на DNS сервисе компании при помощи использования словарей или правил мутации. В данном случае мы заранее подготавливаем большой список слов и возможных поддоменов и опрашиваем DNS сервис в формате слово.example.com, чтобы выявить все имена, которые существуют в инфраструктуре организации.  

Пример использования утилиты subfinder со стандартным словарем для перебора доменных имен:  
```
subfinder -d cyber-ed.ru
```

3. Выполнение запроса AXFR. AXFR запрос, или Zone transfer — это процесс передачи копии базы данных с DNS-зоной от главного сервера к вторичному. В идеале трансфер зоны ограничен только для определенных доверенных серверов, но неправильно сконфигурированные серверы разрешают трансферы любому, кто их попросит.

Пример выполнения такого запроса: 
```
nslookup -q=AXFR example.com (зачастую требует указания конкретного DNS-сервера, к которому будет отправлен запрос).
```

#### Другие примеры инструментов активного поиска:

- amass — многофункциональный инструмент для разведки
- Sublist3r — OSINT инструмент поиска поддоменов 
- assetfinder — пассивный сканер поддоменов на Go

### Сервисы пассивного поиска доменных имен и поддоменов
- dnsdumpster.com
- shodan.io
- censys.io
- crt.sh
- pentest-tools.com

## Сканеры сети
- [Nmap](https://nmap.org/) — один из самых популярных сканеров сети  
[20 Примеров Команды Nmap ](https://denisnovikov.github.io/blog/stunning-examples-of-nmap-commands/)
- [Zenmap](https://nmap.org/zenmap/) — GUI для nmap
- [Masscan](https://github.com/robertdavidgraham/masscan) — сканер сети, разработанный с целью увеличения скорости сканирования крупных сегментов сети, в т.ч. всего пространства адресов IPv4

## Сканирование узлов сети
Сканирование узлов сети работает благодаря устройству таких протоколов, как: `ICMP, TCP/UDP и ARP`  
- `ICMP` — это протокол сетевого уровня стека `TCP/IP`, предназначенный для передачи сервисных сообщений. Обычно используется для передачи сообщений об ошибках и других исключительных ситуациях, возникших при передаче данных, например, недоступность узла.  
- `ARP` — это протокол канального уровня, позволяющий узнать MAC-адрес узла по его IP и наоборот. MAC-адрес, как и IP,может быть полезной информацией для исследователя, но он может быть получен таким образом в пределах одной локальной сети, так как ARP-запрос отправляется по broadcast MAC-адресу `(FF:FF:FF:FF:FF:FF)` и ограничивается одной подсетью.  

Ping-сканирование сети: `nmap -sn--traceroute <network>` (например 192.168.88.0/24)
- `-sn` — ping-сканирование. По умолчанию посылаются запрос на ICMP,эхо-запрос и TCP-ACK пакет на порт 80.
- `--traceroute` — чтобы проводить трассировку маршрута до каждого найденного узла. Эта опция может помочь в составлении карты подсети.  
- `-PS` — TCP-SYN сканирование
- `-PU` — UDP сканирование 
- `-PE; -PP; -PM — ICMP` - сканирование других типов: запрос временной метки (13), информационный запрос (15), запрос адресной маски (17). Многие узлы и брандмауэры могут блокировать исключительно ICMP-пакеты типа echo request, но в спецификации `ICMP` присутствуют еще несколько типов запросов, позволяющих получить ответ от узлов.  

## Как повысить эффективность техники
#### Повысить скорость сканирования на примере сканера Nmap можно:

1. Указав опцию `-sn`, говорящей nmap не делать сканирование портов после обнаружения узла. Таким образом, время не будет тратиться на сканирование множества портов, которые nmap сканирует по умолчанию и будет происходить чисто обнаружение узлов

2. Указав опцию `-n`, отключающей разрешение `DNS-имен`. По умолчанию при обнаружении узлов nmap также производит обратное `DNS` разрешение, для того, чтобы по найденным ip-адресам попробовать узнать их доменные имена. Это не всегда требуется, и отключение разрешения имен может ускорить процесс сканирования

3. Используя опции таймингов -T3, -T4, -T5, и т.д., которые изменяют интервал между сетевыми запросами (чем выше число, тем меньше интервалы между запросами и тем быстрее выполнится скан)  
Возможные варианты: `paranoid(0)`, `sneaky(1)`, `polite(2)`, `normal(3)`, `aggressive(4)` и `insane(5)`.  
Первые два помогают уклоняться от идентификации атакующего.  
2 режим замедляет сканирование.  
3 режим это по умолчанию, то есть никакой оптимизации не будет по данному ключу.  
4 режим ускоряет сканирование.  
5 режим очень быстро сканирует, но есть вероятность в потере точности при сканировании.  

Пример: `nmap -Т4 <example.com>`

#### Скрытность на примере сканера Nmap может быть повышена, если:

- Использовать опцию `--data-length <length>`, добавляющей случайных байтов информации к каждому пакету, что помогает сделать сканирование менее заметным и более похожим на пакеты, генерируемые программой `ping`.

- Добавить опцию `--randomize-hosts`, перемешивающую сканирование узлов, чтобы сделать сканирование менее подозрительным при анализе трафика

- `--top-ports <количество_портов>` - Данный ключ сканирует заданное количество портов по рейтингу их популярности.
- `-F` - позволяет использовать сетевые пакеты минимального объёма
- `-p <номер_порта>` - позволяет сканировать конкретные порты узла
- `-spoof-mac` - для изменения `MAC` адреса атакующего узла
- `-S` - для изменения IP адреса атакующего узла
- `-oN <имя_файла> ` - вывод информации в текстовый файл
- `-iL <имя_файла>` - если есть список `IP адресов`
- `-sV` - позволяет узнать версию используемых служб.
- `-sL` - позволяет определить имя сетевого узла, сканирование которого и происходит.
- `-v`,`-vv`,`-vvv` - выводит подробную информацию о результатах сканирования.
- `-6` - позволит использовать при сканировании IPv6 вместо IPv4.
- `-Pn` - позволяет отключить проверки доступности узла с помощью `ICMP` пакетов, так как некоторые FireWall настроены на откидывание данных пакетов, в следствии чего не удастся просканировать узел. Однако данный ключ замедляет сканирование системы.
- `--script <категории - скриптов>|<директория>|<имя_файла>|all` - У nmap есть свой набор скриптов, которые способны дать определённую информацию при сканировании. Например: ` safe, (intrusive), malware, version, discovery, vuln, auth и default.`

#### Комбинации

Для наиболее сложных задач сканирования (например, при больших количествах) можно пользоваться комбинированием алгоритмов и инструментов: например, если целевая сеть большая и может содержать несколько подсетей, можно быстро прогнать `masscan` по всей сети, чтобы определить подсети в ней, а затем уже по найденным подсетям меньшего размера идти nmap-ом

Пример использования masscan:

`masscan 10.0.0.0/8 192.168.0.0/16 172.16.0.0/12 -p80 --open-only`  
Здесь идет сканирование трех больших сетей `10.0.0.0/8`, `192.168.0.0/16`, `172.16.0.0/12` по `80` порту

Для повышения скрытности можно реализовать возможность использования фиктивных хостов (decoys) с опцией `-D` для того, чтобы скрыть IP-адрес атакующего от `IDS/IPS` систем.

#### Nmap существует шесть состояний сетевых портов :  
- `Открыт (Open)`: Порт открыт и готов к приему входящих соединений.
- `Закрыт (Closed)`: Порт закрыт и не принимает входящие соединения.
- `Фильтруется (Filtered)`: Nmap не может однозначно определить статус порта из-за наличия какого-либо фильтра, который блокирует или фильтрует запросы. Это может быть вызвано файрволлом, IDS/IPS или другими средствами защиты.
- `Открыт|фильтруется (Open|Filtered)`: Состояние, когда Nmap не может однозначно определить, открыт ли порт или он фильтруется. Это может возникнуть, если хост не отвечает на ICMP-запросы, которые Nmap использует для определения состояния портов.
- `Недостоверно (Unreliable)`: Это состояние может возникнуть, если Nmap не может получить надежный ответ от хоста, который приводит к неопределенности статуса порта.  

## Сканирования портов

- `UDP-сканирование` портов, следует использовать ключ `-sU`
- `TCP-сканирование` портов
    - `TCP-SYN сканирование (-sS)`: сканирование, при котором устанавливается неполное TCP соединение.
    - Полное `TCP сканирование` с использованием системного вызова `connect (-sT)`: сканирование, при котором устанавливается полноценное TCP соединение по указанному порту с помощью системного вызова connect.  

Пример:  
- `nmap -sS <example.com>` – TCP-SYN сканирование узла
- `nmap -sT <example.com>` – полное TCP сканирование узла
- `nmap -sU <example.com>` – UDP сканирование узла


Можно использовать нестандартные методики сканирования для улучшения результата, например, сканирование с помощью кастомизации флагов: данный тип сканирования родился из особенностей реализации протоколов по соглашению `RFC`. Суть метода в том, что открытие/закрытие порта можно выявить с помощью особенности: любой пакет, не содержащий установленного бита `SYN`, `RST` или `ACK`, повлечет за собой отправку `RST` в ответ в случае, если порт закрыт, или не повлечет никакого ответа, если порт открыт. Если ни один из этих битов не установлен, то любая комбинация трех оставшихся `(FIN, PSH и URG)` будет являться правильной. В nmap для этого используются следующие ключи:  
- `Null сканирование (-sN)`: не устанавливаются никакие биты `(Флагов в TCP заголовке 0)`.
- `FIN сканирование (-sF)`: устанавливается только `TCP FIN` бит.
- `Xmas сканирование (-sX)`: устанавливаются `FIN, PSH и URG` флаги.
- `TCP ACK сканирование (-sA)`: данный тип сканирование направлен на изучение особенностей реагирования `Firewall`. Если порт не фильтруется, то будет возвращаться TCP ответ с флагом `RST`.
- `TCP Window сканирование (-sW)`: данный тип сканирование похож сутью работы на `TCP ACK`, но при этом способен определять, закрыт или открыт порт за счёт анализа поля `TCP` Window в `RST` ответе. В некоторых системах открытые порты используют положительное значение этого поля (даже в `RST` пакетах), а закрытые — нулевое.
- `TCP сканирование Мэймона (-sM)`: этот тип сканирования носит имя своего первооткрывателя, Уриела Мэймона. Техника практически такая же, как и при `NULL, FIN и Xmas` сканированиях, только в качестве запросов используются запросы `FIN/ACK`. Согласно `RFC 793 (TCP)`, в ответ на такой запрос должен быть сгенерирован RST пакет, если порт открыт или закрыт. Однако многие `BSD` системы просто отбрасывают пакет, если порт открыт.
- `Зомби сканирование (-sI)`: данный метод сканирование позволяет полностью анонимно просканировать узел на информацию о состояние портов, так как сканирование происходит от лица другого узла.
- `FTP bounce сканирование (-b)`: данный метод сканирования основан на возможности одного `FTP` сервера обмениваться файлами с другим `FTP` сервером. Этот метод позволяет достигнуть анонимности, но сейчас крайне мало шансов, что он сработает, так как многие `FTP` сервера пере конфигурированы так, что они не могут отправлять между собой файлы.

## Полезные ссылки
- [Проблемы безопасности UNIX-подобных ОС и Web](https://www.opennet.ru/base/sec/linux_sec_guide.txt.html)